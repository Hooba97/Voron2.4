# variables.cfg

# --- Macro to Set Soak Time ---
[gcode_macro SET_SOAK_TIME]
description: Set the default bed heat soak time in seconds.
gcode:

  {% set requested_time = params.TIME|default(none) %}
  {% if requested_time is not none %}
    {# If a TIME parameter is provided, use that value #}
    {% set final_time = requested_time|int %}
  {% else %}
    {# If no TIME parameter, try to get the existing saved value. #}
    {# If 'soak_time_duration' doesn't exist yet, default to 300 seconds. #}
    {% set final_time = printer.gcode_macro.get('soak_time_duration', 300)|int %}
  {% endif %}

  SAVE_VARIABLE VARIABLE=soak_time_duration VALUE={final_time}
  M118 Soak time set to {final_time} seconds.
  SET_DISPLAY_TEXT MSG="Soak Time: {final_time}s"

# --- Initial Variable Setup (Optional, but recommended) ---
# This macro ensures the 'soak_time_duration' variable is initialized upon Klipper startup
# if it hasn't been saved before. Run this once manually (e.g., after initial setup)
# or add it to your printer.cfg's END_GCODE or a start-up script.
[gcode_macro _INITIALIZE_SOAK_TIME_VARIABLE]
gcode:

  {% if not 'soak_time_duration' in printer.gcode_macro %}
    SAVE_VARIABLE VARIABLE=soak_time_duration VALUE=300
    M118 Initializing soak_time_duration to 300 seconds (5 minutes).
  {% endif %}